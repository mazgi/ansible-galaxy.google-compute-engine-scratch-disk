version: "3.7"
services:
  provisioning:
    build:
      context: Dockerfile.d/provisioning
      args:
        UID: ${UID:-0}
        GID: ${GID:-0}
    working_dir: /workspace
    environment:
      - GOOGLE_CLOUD_KEYFILE_JSON=/workspace/credentials/google-cloud-keyfile.json
      - GOOGLE_APPLICATION_CREDENTIALS=/workspace/credentials/google-cloud-keyfile.json
      - CLOUDSDK_CORE_PROJECT
      - PROJECT_UNIQUE_ID
      - USER_GITHUB_ACCOUNT_NAME
    volumes:
      - provisioning-home:/home/developer # To hold ~/{.config, .docker, ...},
      - provisioning-home:/root # for macOS
      - ${HOME}/.ssh/id_rsa:/home/developer/.ssh/id_rsa:ro
      - ${HOME}/.ssh/id_rsa:/root/.ssh/id_rsa:ro # for macOS
      - .:/workspace
    command:
      - bash
      - -c
      - |
        gcloud auth activate-service-account --key-file=/workspace/credentials/google-cloud-keyfile.json
volumes:
  provisioning-home:
    driver: local
